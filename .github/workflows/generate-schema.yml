name: Generate Oraxen Schema

on:
  push:
    branches: [master, develop]
    paths:
      - 'core/src/main/java/io/th0rgal/oraxen/utils/schema/**'
      - 'core/src/main/java/io/th0rgal/oraxen/items/**'
      - 'core/src/main/java/io/th0rgal/oraxen/mechanics/**'
      - 'build.gradle.kts'
      - 'core/build.gradle.kts'
      - '.github/workflows/generate-schema.yml'
  workflow_dispatch:

jobs:
  generate-schema:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Oraxen
        run: ./gradlew build --no-daemon

      - name: Get version
        id: version
        run: |
          VERSION=$(grep "pluginVersion" gradle.properties | cut -d'=' -f2 | tr -d ' ')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building schema for version: $VERSION"

      - name: Setup test server
        run: |
          mkdir -p test-server/plugins/Oraxen
          cp build/libs/oraxen-*.jar test-server/plugins/
          
          # Download Paper server
          curl -sL -o test-server/paper.jar "https://api.papermc.io/v2/projects/paper/versions/1.21.11/builds/69/downloads/paper-1.21.11-69.jar"
          
          # Download CommandAPI (version must match gradle/oraxenLibs.versions.toml)
          curl -sL -o test-server/plugins/CommandAPI.jar "https://github.com/CommandAPI/CommandAPI/releases/download/11.0.0/CommandAPI-11.0.0-Paper.jar"
          
          # Accept EULA
          echo "eula=true" > test-server/eula.txt
          
          # Create minimal server.properties
          echo "online-mode=false" > test-server/server.properties
          echo "max-tick-time=-1" >> test-server/server.properties
          
          # Create Oraxen settings.yml with debug enabled to trigger schema generation
          echo "debug: true" > test-server/plugins/Oraxen/settings.yml

      - name: Generate schema
        working-directory: test-server
        timeout-minutes: 5
        run: |
          # Start server in background
          java -Xms512M -Xmx1G -jar paper.jar --nogui &
          SERVER_PID=$!
          
          # Wait for schema to be generated
          echo "Waiting for server to start and generate schema..."
          for i in {1..90}; do
            if [ -f "plugins/Oraxen/oraxen-schema.json" ]; then
              echo "Schema generated after ~$((i*2)) seconds!"
              break
            fi
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "Server process died unexpectedly"
              cat logs/latest.log 2>/dev/null || true
              exit 1
            fi
            sleep 2
          done
          
          # Graceful shutdown
          sleep 2
          kill $SERVER_PID 2>/dev/null || true
          sleep 3
          
          # Verify schema was generated
          if [ ! -f "plugins/Oraxen/oraxen-schema.json" ]; then
            echo "ERROR: Schema not generated"
            cat logs/latest.log 2>/dev/null || true
            exit 1
          fi
          
          echo "Schema generated successfully!"

      - name: Prepare schema artifacts
        run: |
          mkdir -p schemas
          cp test-server/plugins/Oraxen/oraxen-schema.json schemas/oraxen-schema.json
          cp test-server/plugins/Oraxen/oraxen-schema.json schemas/oraxen-schema-${{ steps.version.outputs.version }}.json
          
          # Validate JSON
          python3 -c "import json; json.load(open('schemas/oraxen-schema.json'))"
          
          echo "Schema size: $(wc -c < schemas/oraxen-schema.json) bytes"
          echo ""
          echo "Schema sections:"
          python3 -c "import json; d=json.load(open('schemas/oraxen-schema.json')); print('Keys:', list(d.keys())); print('Enums:', len(d.get('enums',{}))); print('Mechanics:', len(d.get('mechanics',{})))"

      - name: Upload schema as artifact
        uses: actions/upload-artifact@v4
        with:
          name: oraxen-schema-${{ steps.version.outputs.version }}
          path: schemas/
          retention-days: 90

      - name: Commit schema to repository
        if: github.ref == 'refs/heads/master'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Only commit if changed
          if [ -f "schemas/oraxen-schema.json" ]; then
            git add schemas/oraxen-schema.json
            git diff --staged --quiet || git commit -m "chore: update oraxen-schema.json for v${{ steps.version.outputs.version }}"
            git push
          fi
